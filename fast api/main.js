/**
 * Minified by jsDelivr using Terser v3.14.1.
 * Original file: /npm/fast-speedtest-api@0.3.2/src/Api.js
 * 
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
const https=require("https"),http=require("http"),Timer=require("./Timer"),ApiError=require("./ApiError"),DEFAULT_SPEEDTEST_TIMEOUT=5e3,DEFAULT_URL_COUNT=5,DEFAULT_BUFFER_SIZE=8,MAX_CHECK_INTERVAL=200;class Api{constructor(t){if(!t)throw new Error("You must define options in Api constructor");if(!t.token)throw new Error("You must define app token");if(t.unit&&"function"!=typeof t.unit)throw new Error("Invalid unit");this.token=t.token,this.verbose=t.verbose||!1,this.timeout=t.timeout||DEFAULT_SPEEDTEST_TIMEOUT,this.https=null==t.https||Boolean(t.https),this.urlCount=t.urlCount||DEFAULT_URL_COUNT,this.bufferSize=t.bufferSize||DEFAULT_BUFFER_SIZE,this.unit=t.unit||Api.UNITS.Bps}static average(t){const e=t.filter(t=>t);return 0===e.length?0:e.reduce((t,e)=>t+e)/e.length}async get(t){return new Promise((e,r)=>{const s=(this.https?https:http).get(t,t=>{if(t.headers["content-type"].includes("json")){t.setEncoding("utf8");let r="";t.on("data",t=>{r+=t}),t.on("end",()=>{const o=JSON.parse(r);t.data=o,e({response:t,request:s})})}else e({response:t,request:s})}).on("error",t=>{r(t)})})}async getTargets(){try{const t=[];for(;t.length<this.urlCount;){const{response:e}=await this.get(`http${this.https?"s":""}://api.fast.com/netflix/speedtest?https=${this.https?"true":"false"}&token=${this.token}&urlCount=${this.urlCount-t.length}`);if(200!==e.statusCode){if(403===e.statusCode)throw new ApiError({code:ApiError.CODES.BAD_TOKEN});throw new ApiError({code:ApiError.CODES.UNKNOWN})}t.push(...e.data)}return t.map(t=>t.url)}catch(t){throw"ENOTFOUND"===t.code?this.https?new ApiError({code:ApiError.CODES.UNREACHABLE_HTTPS_API}):new ApiError({code:ApiError.CODES.UNREACHABLE_HTTP_API}):t}}async getSpeed(){let t=null;try{t=await this.getTargets()}catch(t){throw t}let e=0;const r=[],s=new Timer(this.timeout,()=>{r.forEach(t=>t.abort())});return t.forEach(async t=>{const{response:o,request:n}=await this.get(t);r.push(n),o.on("data",t=>{e+=t.length}),o.on("end",()=>{s.stop()})}),new Promise(t=>{let r=0;const o=new Array(this.bufferSize).fill(null),n=Math.min(this.timeout/this.bufferSize,MAX_CHECK_INTERVAL),i=setInterval(()=>{r=(r+1)%o.length,o[r]=e/(n/1e3),this.verbose&&console.log(`Current speed: ${this.unit(this.constructor.average(o))} ${this.unit.name}`),e=0},n);s.addCallback(()=>{clearInterval(i),t(this.unit(this.constructor.average(o)))}),s.start()})}}Api.UNITS={Bps:t=>t,KBps:t=>t/1e3,MBps:t=>t/1e6,GBps:t=>t/1e9,bps:t=>8*t,Kbps:t=>8*t/1e3,Mbps:t=>8*t/1e6,Gbps:t=>8*t/1e9},module.exports=Api;
//# sourceMappingURL=/sm/a82527c9687c80bc794ab16f6fc7d520f1719f6ee5abfea367f4a7545d1f3c38.map